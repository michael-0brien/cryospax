
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="The documentation for cryoSPAX.">
      
      
        <meta name="author" content="Michael O'Brien and David Silva Sanchez">
      
      
        <link rel="canonical" href="https://michael-0brien.github.io/cryospax/examples/simulate-particles/">
      
      
        <link rel="prev" href="../read-dataset/">
      
      
        <link rel="next" href="../../api/dataset/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.7">
    
    
      
        <title>Simulate particles and write STAR file - Cryo-EM single particle analysis in JAX</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8608ea7d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../assets/_hippogriffe.css">
    
      <link rel="stylesheet" href="../../_static/custom_css.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Cryo-EM single particle analysis in JAX" class="md-header__button md-logo" aria-label="Cryo-EM single particle analysis in JAX" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m20.79 13.95-2.33.62-2-1.13v-2.88l2-1.13 2.33.62.52-1.93-1.77-.47.46-1.77-1.93-.52-.62 2.33-2 1.13L13 7.38V5.12l1.71-1.71L13.29 2 12 3.29 10.71 2 9.29 3.41 11 5.12v2.26L8.5 8.82l-2-1.13-.58-2.33L4 5.88l.47 1.77-1.77.47.52 1.93 2.33-.62 2 1.13v2.89l-2 1.13-2.33-.62-.52 1.93 1.77.47L4 18.12l1.93.52.62-2.33 2-1.13L11 16.62v2.26l-1.71 1.71L10.71 22 12 20.71 13.29 22l1.41-1.41-1.7-1.71v-2.26l2.5-1.45 2 1.13.62 2.33 1.88-.51-.47-1.77 1.77-.47zM9.5 10.56 12 9.11l2.5 1.45v2.88L12 14.89l-2.5-1.45z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cryo-EM single particle analysis in JAX
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Simulate particles and write STAR file
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/michael-0brien/cryospax" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    michael-0brien/cryospax
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Welcome to cryoSPAX!

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../overview/" class="md-tabs__link">
        
  
    
  
  Overview

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../read-dataset/" class="md-tabs__link">
          
  
  Examples

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../api/dataset/" class="md-tabs__link">
          
  
  API

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../cli/" class="md-tabs__link">
        
  
    
  
  The command line interface

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../faq/" class="md-tabs__link">
        
  
    
  
  FAQs

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Cryo-EM single particle analysis in JAX" class="md-nav__button md-logo" aria-label="Cryo-EM single particle analysis in JAX" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m20.79 13.95-2.33.62-2-1.13v-2.88l2-1.13 2.33.62.52-1.93-1.77-.47.46-1.77-1.93-.52-.62 2.33-2 1.13L13 7.38V5.12l1.71-1.71L13.29 2 12 3.29 10.71 2 9.29 3.41 11 5.12v2.26L8.5 8.82l-2-1.13-.58-2.33L4 5.88l.47 1.77-1.77.47.52 1.93 2.33-.62 2 1.13v2.89l-2 1.13-2.33-.62-.52 1.93 1.77.47L4 18.12l1.93.52.62-2.33 2-1.13L11 16.62v2.26l-1.71 1.71L10.71 22 12 20.71 13.29 22l1.41-1.41-1.7-1.71v-2.26l2.5-1.45 2 1.13.62 2.33 1.88-.51-.47-1.77 1.77-.47zM9.5 10.56 12 9.11l2.5 1.45v2.88L12 14.89l-2.5-1.45z"/></svg>

    </a>
    Cryo-EM single particle analysis in JAX
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/michael-0brien/cryospax" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    michael-0brien/cryospax
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Welcome to cryoSPAX!
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../read-dataset/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Read a dataset
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Simulate particles and write STAR file
    
  </span>
  

      </a>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/dataset/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cryo-EM dataset manipulation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/simulate-particles/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Simulate particle stacks
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cli/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    The command line interface
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../faq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FAQs
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



  <h1>Simulate particles and write STAR file</h1>

<p>This tutorial demonstrates how to simulate a cryo-EM dataset through cryoJAX's built-in STAR file utilities. In doing so, the tutorial builds off of the <a href="https://michael-0brien.github.io/cryojax/examples/extending-cryojax/">tutorial</a> demonstrating how to make custom image simulation methods.</p>
<p>This tutorial is split into three parts:</p>
<p>1) Generate a STAR file of particle parameters
2) Define an image simulator given those parameters and a custom <code>AbstractVolumeParametrization</code>
3) Simulate images with added noise and write to the STAR file and to disk.</p>
<p>This process is designed to be flexible: users design their own image formation model to generate a dataset. This tutorial can easily be adapted or modified to include additional functionality.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Plotting imports and functions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.axes_grid1</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_axes_locatable</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>
</code></pre></div>
<p>To start, generate particle parameters and write a STAR file.</p>
<p>To do this, first we must <code>vmap</code> over JAX random number generator keys and sample particle parameters for the pose and CTF. You can adapt this function to your needs, such as adapting the range of the distributions for the random parameters, or changing wheter a parameter is random or not.</p>
<p>Then, save a STAR file using the utilities in the <code>cryojax.dataset</code> submodule.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cryojax.simulator</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cxs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">equinox</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">eqx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax.numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">jnp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cryojax.rotations</span><span class="w"> </span><span class="kn">import</span> <span class="n">SO3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jaxtyping</span><span class="w"> </span><span class="kn">import</span> <span class="n">PRNGKeyArray</span>


<span class="nd">@eqx</span><span class="o">.</span><span class="n">filter_vmap</span><span class="p">(</span><span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">make_particle_parameters</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">PRNGKeyArray</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">cxs</span><span class="o">.</span><span class="n">BasicImageConfig</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate random parameters.&quot;&quot;&quot;</span>
    <span class="c1"># Pose</span>
    <span class="c1"># ... instantiate rotations</span>
    <span class="n">key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>  <span class="c1"># split the key to use for the next random number</span>
    <span class="n">rotation</span> <span class="o">=</span> <span class="n">SO3</span><span class="o">.</span><span class="n">sample_uniform</span><span class="p">(</span><span class="n">subkey</span><span class="p">)</span>

    <span class="c1"># ... now in-plane translation</span>
    <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>  <span class="c1"># do this everytime you use a key!!</span>
    <span class="n">offset_in_angstroms</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,),</span> <span class="n">minval</span><span class="o">=-</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">))</span>
        <span class="o">/</span> <span class="mi">2</span>
        <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">pixel_size</span>
    <span class="p">)</span>
    <span class="c1"># ... build the pose</span>
    <span class="n">pose</span> <span class="o">=</span> <span class="n">cxs</span><span class="o">.</span><span class="n">EulerAnglePose</span><span class="o">.</span><span class="n">from_rotation_and_translation</span><span class="p">(</span><span class="n">rotation</span><span class="p">,</span> <span class="n">offset_in_angstroms</span><span class="p">)</span>

    <span class="c1"># CTF Parameters</span>
    <span class="c1"># ... defocus</span>
    <span class="n">key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">defocus_in_angstroms</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="p">(),</span> <span class="n">minval</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="mi">15000</span><span class="p">)</span>
    <span class="c1"># ... astigmatism</span>
    <span class="n">key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">astigmatism_in_angstroms</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="p">(),</span> <span class="n">minval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">astigmatism_angle</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="p">(),</span> <span class="n">minval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="c1"># Now non-random values</span>
    <span class="n">spherical_aberration_in_mm</span> <span class="o">=</span> <span class="mf">2.7</span>
    <span class="n">amplitude_contrast_ratio</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="c1"># Build the CTF</span>
    <span class="n">transfer_theory</span> <span class="o">=</span> <span class="n">cxs</span><span class="o">.</span><span class="n">ContrastTransferTheory</span><span class="p">(</span>
        <span class="n">ctf</span><span class="o">=</span><span class="n">cxs</span><span class="o">.</span><span class="n">AstigmaticCTF</span><span class="p">(</span>
            <span class="n">defocus_in_angstroms</span><span class="o">=</span><span class="n">defocus_in_angstroms</span><span class="p">,</span>
            <span class="n">astigmatism_in_angstroms</span><span class="o">=</span><span class="n">astigmatism_in_angstroms</span><span class="p">,</span>
            <span class="n">astigmatism_angle</span><span class="o">=</span><span class="n">astigmatism_angle</span><span class="p">,</span>
            <span class="n">spherical_aberration_in_mm</span><span class="o">=</span><span class="n">spherical_aberration_in_mm</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">amplitude_contrast_ratio</span><span class="o">=</span><span class="n">amplitude_contrast_ratio</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;image_config&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
        <span class="s2">&quot;pose&quot;</span><span class="p">:</span> <span class="n">pose</span><span class="p">,</span>
        <span class="s2">&quot;transfer_theory&quot;</span><span class="p">:</span> <span class="n">transfer_theory</span><span class="p">,</span>
    <span class="p">}</span>


<span class="c1"># Generate particle parameters. First, the image config</span>
<span class="n">pad_options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">cxs</span><span class="o">.</span><span class="n">BasicImageConfig</span><span class="p">(</span>
    <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span>
    <span class="n">pixel_size</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
    <span class="n">voltage_in_kilovolts</span><span class="o">=</span><span class="mf">300.0</span><span class="p">,</span>
    <span class="n">pad_options</span><span class="o">=</span><span class="n">pad_options</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># ... RNG keys</span>
<span class="n">number_of_images</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">keys</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">number_of_images</span><span class="p">)</span>
<span class="c1"># ... make parameters</span>
<span class="n">particle_parameters</span> <span class="o">=</span> <span class="n">make_particle_parameters</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>/Users/michael/venvs/cryojax-spa/lib/python3.11/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cryospax</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">spx</span>


<span class="c1"># Generate STAR file</span>
<span class="n">parameter_file</span> <span class="o">=</span> <span class="n">spx</span><span class="o">.</span><span class="n">RelionParticleParameterFile</span><span class="p">(</span>
    <span class="n">path_to_starfile</span><span class="o">=</span><span class="s2">&quot;./outputs/particles.star&quot;</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span>  <span class="c1"># writing mode!</span>
    <span class="n">exists_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># in case the file already exists</span>
    <span class="n">options</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">broadcasts_image_config</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">pad_options</span><span class="o">=</span><span class="n">pad_options</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="n">parameter_file</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">particle_parameters</span><span class="p">)</span>
<span class="n">parameter_file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<p>Next, create a custom <code>AbstractVolumeParametrization</code> to simulate images randomized over a structure's discrete conformations. We will simulate images of thyroglobulin in two conformations. See the <a href="https://michael-0brien.github.io/cryojax/examples/extending-cryojax/">tutorial</a> for creating cryoJAX extensions for more information.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">override</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">jaxtyping</span><span class="w"> </span><span class="kn">import</span> <span class="n">Array</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">Int</span>


<span class="k">class</span><span class="w"> </span><span class="nc">DiscreteConformationSampler</span><span class="p">(</span><span class="n">cxs</span><span class="o">.</span><span class="n">AbstractVolumeParametrization</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sample discrete conformational heterogeneity.</span>

<span class="sd">    Note that sampling occurs upon intialization and the conformation</span>
<span class="sd">    index sampled is stored.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">sampled_volume</span><span class="p">:</span> <span class="n">cxs</span><span class="o">.</span><span class="n">AbstractVolumeRepresentation</span>
    <span class="n">conformation</span><span class="p">:</span> <span class="n">Int</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rng_key</span><span class="p">:</span> <span class="n">PRNGKeyArray</span><span class="p">,</span>
        <span class="n">conformational_space</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">cxs</span><span class="o">.</span><span class="n">AbstractVolumeRepresentation</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
        <span class="n">weights</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="n">Float</span><span class="p">[</span><span class="n">Array</span><span class="p">,</span> <span class="s2">&quot; _&quot;</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">conformational_space</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">n_conformations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">conformational_space</span><span class="p">)</span>
        <span class="n">conformation</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
            <span class="n">rng_key</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_conformations</span><span class="p">),</span> <span class="n">p</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Assumes that the `AbstractVolumeRepresentation` is a pytree</span>
        <span class="c1"># of arrays only. Otherwise, calls to `equinox.partition` and</span>
        <span class="c1"># `equinox.combine` would be necessary</span>
        <span class="n">stacked_volume</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="o">*</span><span class="n">xs</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="o">*</span><span class="n">conformational_space</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sampled_volume</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">conformation</span><span class="p">],</span> <span class="n">stacked_volume</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conformation</span> <span class="o">=</span> <span class="n">conformation</span>

    <span class="nd">@override</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_representation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">rng_key</span><span class="p">:</span> <span class="n">PRNGKeyArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cxs</span><span class="o">.</span><span class="n">AbstractVolumeRepresentation</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampled_volume</span>


<span class="k">def</span><span class="w"> </span><span class="nf">make_conformational_space</span><span class="p">(</span><span class="n">paths_to_pdb</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Instantiate a `DiscreteConformationSampler`</span>
<span class="sd">    simply given multiple paths to PDB files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">path_to_pdb</span> <span class="ow">in</span> <span class="n">paths_to_pdb</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">cxs</span><span class="o">.</span><span class="n">load_tabulated_volume</span><span class="p">(</span>
            <span class="n">path_to_pdb</span><span class="p">,</span>
            <span class="n">selection_string</span><span class="o">=</span><span class="s2">&quot;name CA&quot;</span><span class="p">,</span>
            <span class="n">include_b_factors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">output_type</span><span class="o">=</span><span class="n">cxs</span><span class="o">.</span><span class="n">GaussianMixtureVolume</span><span class="p">,</span>
        <span class="p">)</span>


<span class="n">conformational_space</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
    <span class="n">make_conformational_space</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;./data/thyroglobulin_unbent.pdb&quot;</span><span class="p">,</span> <span class="s2">&quot;./data/thyroglobulin_bent.pdb&quot;</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<p>Now, define a function that simulates images given the <code>DiscreteConformationSampler</code>. Ultimately this will be passed to the <a class="autorefs autorefs-internal" href="../../api/simulate-particles/#cryospax.simulate_particle_stack"><code>cryospax.simulate_particle_stack</code></a> utility. For reasons we will see, the following function signature is required.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">simulate_fn</span><span class="p">(</span><span class="n">particle_parameters</span><span class="p">,</span> <span class="n">constant_args</span><span class="p">,</span> <span class="n">per_particle_args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute a single image from the given particle parameters.</span>

<span class="sd">    **Arguments:**</span>

<span class="sd">    - `particle_parameters`:</span>
<span class="sd">        A dictionary containing the parameters for the particle.</span>
<span class="sd">        This is an element of a `RelionParticleParameterFile`.</span>
<span class="sd">    - `constant_args`:</span>
<span class="sd">        A PyTree whose arrays do not have a batch dimension, i.e. they stay</span>
<span class="sd">        constant across all particles.</span>
<span class="sd">    - `per_particle_args`:</span>
<span class="sd">        A PyTree whose arrays have a batch dimension matching the number of</span>
<span class="sd">        particles in `particle_parameters`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div>
<p>In this function, we will simulate images at a randomly sampled SNR.</p>
<div class="admonition info">
<p class="admonition-title">Simulating images at a given SNR</p>
<p>The <code>GaussianWhiteNoiseModel</code> in cryoJAX simulates images as image = signal + noise. 
The signal is normalized by defining a region where we know there is signal, where we can measure the
mean and standard deviation of our simulated image without noise. After normalizing, we can set the signal-to-noise ratio (SNR) by setting the noise variance to 1 and the signal variance equal to the <code>SNR</code>. The latter step is simply done by scaling the normalized image by a constant.</p>
</div>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cryojax.ndimage</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">im</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax.random</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">jr</span>


<span class="k">def</span><span class="w"> </span><span class="nf">simulate_fn</span><span class="p">(</span><span class="n">particle_parameters</span><span class="p">,</span> <span class="n">conformational_space</span><span class="p">,</span> <span class="n">rng_key</span><span class="p">):</span>
    <span class="c1"># Generate RNG keys for each part of the process</span>
    <span class="n">conformation_rng_key</span><span class="p">,</span> <span class="n">noise_rng_key</span><span class="p">,</span> <span class="n">snr_rng_key</span> <span class="o">=</span> <span class="n">jr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="c1"># Build image model, including normalization within a circular mask</span>
    <span class="c1"># around each particle</span>
    <span class="n">image_config</span><span class="p">,</span> <span class="n">pose</span><span class="p">,</span> <span class="n">transfer_theory</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">particle_parameters</span><span class="p">[</span><span class="s2">&quot;image_config&quot;</span><span class="p">],</span>
        <span class="n">particle_parameters</span><span class="p">[</span><span class="s2">&quot;pose&quot;</span><span class="p">],</span>
        <span class="n">particle_parameters</span><span class="p">[</span><span class="s2">&quot;transfer_theory&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">CircularCosineMask</span><span class="p">(</span>
        <span class="n">coordinate_grid</span><span class="o">=</span><span class="n">image_config</span><span class="o">.</span><span class="n">coordinate_grid_in_angstroms</span><span class="p">,</span>
        <span class="n">radius</span><span class="o">=</span><span class="mf">150.0</span><span class="p">,</span>
        <span class="n">rolloff_width</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">xy_offset</span><span class="o">=</span><span class="n">pose</span><span class="o">.</span><span class="n">offset_in_angstroms</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">volume</span> <span class="o">=</span> <span class="n">DiscreteConformationSampler</span><span class="p">(</span>
        <span class="n">conformation_rng_key</span><span class="p">,</span> <span class="n">conformational_space</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">image_model</span> <span class="o">=</span> <span class="n">cxs</span><span class="o">.</span><span class="n">make_image_model</span><span class="p">(</span>
        <span class="n">volume</span><span class="p">,</span>
        <span class="n">pose</span><span class="o">=</span><span class="n">pose</span><span class="p">,</span>
        <span class="n">image_config</span><span class="o">=</span><span class="n">image_config</span><span class="p">,</span>
        <span class="n">transfer_theory</span><span class="o">=</span><span class="n">transfer_theory</span><span class="p">,</span>
        <span class="n">normalizes_signal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">signal_region</span><span class="o">=</span><span class="n">mask</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Build noise model at a randomly sampled SNR within a</span>
    <span class="c1"># uniform range, then simulate</span>
    <span class="n">snr</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">snr_rng_key</span><span class="p">,</span> <span class="n">minval</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">noise_model</span> <span class="o">=</span> <span class="n">cxs</span><span class="o">.</span><span class="n">GaussianWhiteNoiseModel</span><span class="p">(</span>
        <span class="n">image_model</span><span class="p">,</span>
        <span class="n">variance</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">signal_scale_factor</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">snr</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">noise_model</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">rng_key</span><span class="o">=</span><span class="n">noise_rng_key</span><span class="p">)</span>


<span class="c1"># Simulate a test image</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">test_parameters</span> <span class="o">=</span> <span class="n">parameter_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">simulate_fn</span><span class="p">(</span><span class="n">test_parameters</span><span class="p">,</span> <span class="n">conformational_space</span><span class="p">,</span> <span class="n">rng_key</span><span class="o">=</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="mi">1234</span><span class="p">))</span>
<span class="n">plot_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Simulated Image&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(&lt;Figure size 300x300 with 2 Axes&gt;,
 &lt;Axes: title={&#39;center&#39;: &#39;Simulated Image&#39;}&gt;)
</code></pre></div>
<p><img alt="img" src="../_data/c2e84891c6a2466fae0fbe9ef9bc52a9.png" /></p>
<p>Finally, simulate a dataset using <a class="autorefs autorefs-internal" href="../../api/simulate-particles/#cryospax.simulate_particle_stack"><code>cryospax.simulate_particle_stack</code></a>.</p>
<div class="admonition info">
<p class="admonition-title">The <code>simulate_particle_stack</code> tool</p>
<p>This function takes in two key arguments: a STAR file and a function
that simulates images. We just defined the latter, but we also need
build off of the <code>RelionParticleParameterFile</code> we defined and build what
is called a <code>RelionParticleDataset</code>. This specifies how to write
the MRC files.</p>
</div>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>


<span class="c1"># Instantiate MRC I/O via the `RelionParticleDataset`</span>
<span class="n">path_to_relion_project</span> <span class="o">=</span> <span class="s2">&quot;./outputs/&quot;</span>
<span class="n">mrcfile_output_folder</span> <span class="o">=</span> <span class="s2">&quot;images/&quot;</span>
<span class="n">path_to_mrcfiles</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">path_to_relion_project</span><span class="p">,</span> <span class="n">mrcfile_output_folder</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">path_to_mrcfiles</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="n">path_to_mrcfiles</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">spx</span><span class="o">.</span><span class="n">RelionParticleDataset</span><span class="p">(</span>
    <span class="n">parameter_file</span><span class="p">,</span>
    <span class="n">path_to_relion_project</span><span class="o">=</span><span class="n">path_to_relion_project</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span>
    <span class="n">mrcfile_settings</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;overwrite&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;output_folder&quot;</span><span class="p">:</span> <span class="n">mrcfile_output_folder</span><span class="p">,</span>
    <span class="p">},</span>  <span class="c1"># customize your MRC output</span>
<span class="p">)</span>
</code></pre></div>
<p>Finally, let's use <code>simulate_particle_stack</code> to simulate images. </p>
<div class="highlight"><pre><span></span><code><span class="n">rng_keys</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">1234</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
<span class="n">spx</span><span class="o">.</span><span class="n">simulate_particle_stack</span><span class="p">(</span>
    <span class="n">dataset</span><span class="p">,</span>
    <span class="n">simulate_fn</span><span class="p">,</span>
    <span class="n">constant_args</span><span class="o">=</span><span class="n">conformational_space</span><span class="p">,</span>
    <span class="n">per_particle_args</span><span class="o">=</span><span class="n">rng_keys</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>  <span class="c1"># how many images to simulate in parallel</span>
    <span class="n">images_per_file</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>  <span class="c1"># how many images in each MRC file</span>
    <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>
<p>Finally, as we saw in the <a href="https://michael-0brien.github.io/cryojax/examples/read-dataset/">load cryo-EM images</a> tutorial, we can load images and parameters using the <code>RelionParticleDataset</code>.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_image_stack</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">n_images_per_side</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">n_images_per_side</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">n_images_per_side</span><span class="p">)</span>
    <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">images</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()):</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">images</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>


<span class="n">particles</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
<span class="n">plot_image_stack</span><span class="p">(</span><span class="n">particles</span><span class="p">[</span><span class="s2">&quot;images&quot;</span><span class="p">])</span>
</code></pre></div>
<p><img alt="img" src="../_data/c36d7a3161f74d21abb121d9356848a0.png" /></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "toc.integrate"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>